<xml xmlns="https://developers.google.com/blockly/xml"><variables></variables><block type="pxt-on-start" id="KBq0-R{l~ls}Bwz{fLnb" x="0" y="0"><statement name="HANDLER"><block type="typescript_statement" id="/-icslD/0gV1,zVkWYH~"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="namespace ZETag_R30 {" line1="    const txBuffer = pins.createBuffer(1);" line2="" line3="    /**" line4="     * Binary data transmission over UART" line5="     * @param TX_data: 8bit data" line6="    */" line7="    function UART_BIN_TX(txData: number): void {" line8="        txBuffer.setUint8(0, txData);" line9="        serial.writeBuffer(txBuffer)" line10="    }" line11="" line12="    /**" line13="     * Binary data reception over UART" line14="     * @param value: none" line15="     * @return value: 16bit data If return value is 256, reception time out." line16="    */" line17="    function UART_BIN_RX(): number {" line18="        const rxBuffer = serial.readBuffer(1)   // Bloking function (wait till receipt)" line19="        if (rxBuffer.length &gt; 0) {              // When receive data, alway length &gt; 0" line20="            return rxBuffer[0]" line21="        }" line22="        return 0;                               // Never come to this line." line23="    }" line24="" line25="    function receive_query(): number[] {" line26="        let response = [0, 0, 0, 0, 0, 0, 0, 0, 0]" line27="        let timeoutCounter = 0" line28="" line29="        while (true) {" line30="            const data = UART_BIN_RX();" line31="            if (data == 0xff) break;" line32="            timeoutCounter++;" line33="            if (timeoutCounter &gt; 15) return response; // Timeout" line34="        }" line35="" line36="        if (UART_BIN_RX() == 0) {   // FF 00 を待つ" line37="            response[0] = 0xff;" line38="            response[1] = 0x0;" line39="            let length = UART_BIN_RX();" line40="            if (length &gt; 6) length = 6;" line41="            response[2] = length;" line42="            let sum = 0xff + 0x00 + length" line43="            for (let i = 0; i &lt; length - 1; i++) {" line44="                const d = UART_BIN_RX() &amp; 0xff;" line45="                response[3 + i] = d;" line46="                sum += d;" line47="            }" line48="            const crc = UART_BIN_RX() &amp; 0xFF;" line49="            response[length + 2] = crc;   // Store CRC data to response" line50="            response = response.slice(0, length + 2); //omit redandant data" line51="            if ((sum &amp; 0xff) != crc) {" line52="                response = [3]" line53="            }" line54="        }" line55="        else response = [1];" line56="        if (response[3] == 0xff) {" line57="            response = [2]" line58="        }" line59="        return response" line60="    }" line61="" line62="    /**" line63="     * Send ZETag command execution" line64="     * @param txArray : number[]" line65="     * @param querySize: number" line66="     * @return queryData[]" line67="        queryData[0]:" line68="                0xff    Query data is ready," line69="                   1    Time out error," line70="                   2    Size error (Query size &lt;&gt; Receipt size)," line71="                   3    ZeTag error," line72="                   4    Checksum error," line73="                   5    Query data error" line74="       */" line75="    //% blockId=Send_ZETag_command block=&quot;Send ZETag command %txArray&quot;" line76="    //% group=&quot;Send data&quot; weight=95 blockGap=8" line77="    export function Send_ZETag_command(txArray: number[]): number[] {" line78="        const txArraySize = txArray.length" line79="        for (let l = 0; l &lt; txArraySize; l++) {" line80="            UART_BIN_TX(txArray[l])" line81="        }" line82="        let queryData = receive_query()" line83="        if ((queryData[3] == 0xf1) &amp;&amp; (txArray[3] == 0xf0)) {" line84="            return queryData" line85="        } else if (queryData[3] != txArray[3]) {" line86="            queryData[0] = 4" line87="        }" line88="        if (queryData[3] != txArray[3]) {" line89="            if ((queryData[3] != 0xf1) || (txArray[3] != 0xf0)) {" line90="                queryData[0] = 4" line91="            }" line92="        }" line93="        return queryData" line94="    }" line95="" line96="    /**" line97="     * send zetag application data" line98="     */" line99="    //% blockId=Transmit_ZETag_data block=&quot;Transmit ZETag data %dataArray&quot;" line100="    //% group=&quot;Send data&quot; weight=95 blockGap=8" line101="    export function Transmit_ZETag_data(txArray: number[]): void {" line102="        // 0xff+2+0x80=0x181 -&gt; 0x81" line103="        // Query FF 00 02 80 81" line104="        let num = txArray.length" line105="        if (num &lt; 1) return;" line106="        if (num &gt; 30) num = 30;" line107="        // 0xff+2+0x80=0x181 -&gt; 0x81  FF 00 02 80 xx xx xx" line108="        let checkSum = 0x81 + num" line109="        for (let m = 0; m &lt; num; m++) {" line110="            checkSum += txArray[m]" line111="        }" line112="        checkSum %= 256;" line113="        const header = [0xff, 0x00, num + 2, 0x80];" line114="        const response2 = Send_ZETag_command(header.concat(txArray).concat([checkSum]));" line115="    }" line116="" line117="    // --- 既存ロジック（そのまま利用） ---" line118="" line119="    /**" line120="     * get Protocol Version" line121="    */" line122="    //% blockId=Get_Protocol_Version block=&quot;Get Protocol Version&quot;" line123="    //% subcategory=&quot;Other&quot;" line124="    //% weight=95 blockGap=8" line125="    export function Get_Protocol_Version (): number {" line126="        // FF 00 02 02 03 /* バージョンの取得 */ " line127="        // Query FF 00 04 02 01 04 0A とか　FF 00 04 02 01 00 06" line128="        // メインバージョン(4バイト目）、サブバージョン（5バイト目）で回答" line129="        //　この関数からは上位4ビットがメイン、下位4ビットがサブバージョンを示す" line130="" line131="        const response3 = Send_ZETag_command([0xff, 0x00, 0x02, 0x02, 0x03])" line132="        return (((response3[4] &amp; 0xf) &lt;&lt; 4) + (response3[5] &amp; 0xf)) &amp; 0xff;" line133="    }" line134="" line135="    /**" line136="     * set tx power" line137="    */" line138="    //% blockId=Set_Operating_Mode block=&quot;Set Operating Mode %mode&quot;" line139="    //% subcategory=&quot;Other&quot;" line140="    //% weight=95 blockGap=8" line141="    //% mode.min=0 mode.max=1 mode.defl=0" line142="    export function Set_Operating_Mode(mode: OP_Mode): void {" line143="        // FF 00 03 44 00 46 ; normal mode (mode = 0)" line144="        // FF 00 05 44 01 00 01 4A ; test mode (mode = 1)" line145="        // Query FF 00 02 44 45" line146="" line147="        if (mode === OP_Mode.Test) {" line148="            const response4 = Send_ZETag_command([0xff, 0x00, 0x05, 0x44, 0x01, 0x00, 0x01, 0x4a])" line149="        } else {" line150="            const response5 = Send_ZETag_command([0xff, 0x00, 0x03, 0x44, 0x00, 0x46])" line151="            mode = OP_Mode.Normal" line152="        }" line153="    }" line154="      " line155="    /**" line156="     * set tx power" line157="     */" line158="    //% blockId=Set_TX_Power block=&quot;Set TX Power %txPower (dB)&quot;" line159="    //% subcategory=&quot;Other&quot;" line160="    //% weight=95 blockGap=8" line161="    //% txPower.min=1 txPower.max=10 txPower.defl=10" line162="    export function Set_TX_Power(txPower: number): void {" line163="        if (txPower == 0) txPower = 1;" line164="        else if (txPower &gt;= 10) txPower = 10;" line165="" line166="        let txPowerData = txPower * 2" line167="        // FF 00 03 41 10 53; 出力8dB設定" line168="        // FF+00+03+41=0x143 -&gt; 0x43" line169="        // Query FF 00 02 41 42" line170="        const response42 = Send_ZETag_command([0xff, 0x00, 0x03, 0x41, txPowerData, (0x43 + txPowerData) % 256])" line171="    }" line172="" line173="    /**" line174="     * set channel spacing" line175="     */" line176="    //% blockId=Set_channel_spacing block=&quot;Set channel spacing %chSpace (kHz)&quot;" line177="    //% subcategory=&quot;Other&quot;" line178="    //% weight=95 blockGap=8" line179="    //% chSpace.min=100 chSpace.max=200 chSpace.defl=100" line180="    export function Set_channel_spacing(chSpace: number): void {" line181="        // FF 00 03 F0 64 56; 100KHz設定" line182="        // FF+00+03+F0=1F2 -&gt; 0xf2" line183="        // Query FF 00 02 F1 F2" line184="        if (chSpace &lt;= 100) {" line185="            chSpace = 100" line186="        } else if (chSpace &gt;= 200) {" line187="            chSpace = 200" line188="        }" line189="        const response32 = Send_ZETag_command([0xff, 0x00, 0x03, 0xf0, chSpace, (0xf2 + chSpace) % 256]);" line190="    }" line191="" line192="    /**" line193="     * set transmission frequency" line194="     */" line195="    //% blockId=Set_Frequency block=&quot;Set Frequency %frequency (Hz) %chNum (ch) %chStep&quot;" line196="    //% subcategory=&quot;Other&quot;" line197="    //% weight=95 blockGap=8" line198="    //% frequency.min=470000000 frequency.max=928000000 frequency.defl=922080000" line199="    //% chNum.min=1 chNum.max=6 chNum.defl=2" line200="    //% chStep.min=1 chStep.max=2 chStep.defl=2" line201="    export function Set_Frequency(frequency: number, chNum: number, chStep: number): void {" line202="        // Query FF 00 02 40 41" line203="        if (chNum &lt;= 1) chNum = -1;" line204="        else if (chNum &gt;= 6) chNum = 6;" line205="" line206="        if (chStep == 0) chStep = 1;" line207="        else if (chStep &gt;= 2) chStep = 2;" line208="" line209="        if (frequency &lt; 470000000) frequency = 470000000;" line210="        else if (frequency &gt; 928000000) frequency = 928000000;" line211="        else if ((frequency &gt; 510000000) &amp;&amp; (frequency &lt; 920600000)) frequency = 510000000;" line212="" line213="        let txArray = [" line214="            0xff, 0x00, 0x08 + chNum, 0x40, 0x01," line215="            (frequency &gt;&gt; 24) &amp; 0xff," line216="            (frequency &gt;&gt; 16) &amp; 0xff," line217="            (frequency &gt;&gt; 8) &amp; 0xff," line218="            frequency &amp; 0xff," line219="            chNum, 0, 0, 0, 0, 0, 0, 0" line220="        ]" line221="        if (chNum &gt;= 2) {" line222="            for (let n = 0; n &lt; chNum; n++) {" line223="                txArray[10 + n] = n * chStep" line224="            }" line225="        } else {" line226="            txArray[4] = 0" line227="        }" line228="        let checkSum2 = 0" line229="        for (let o = 0; o &lt; chNum + 10; o++) {" line230="            checkSum2 += txArray[o]" line231="        }" line232="        checkSum2 %= 256" line233="        txArray[10 + chNum] = checkSum2" line234="" line235="        txArray = txArray.slice(0, 11 + chNum); // omit redundant data" line236="" line237="        const response52 = Send_ZETag_command(txArray)" line238="    }" line239="" line240="    /**" line241="     * set tx mode" line242="     */" line243="    //% blockId=Set_TX_Mode block=&quot;Set TX Mode %txMode&quot;" line244="    //% subcategory=&quot;Other&quot;" line245="    //% weight=95 blockGap=8" line246="    //% txMode.defl=Mode.FSK4" line247="    export function Set_TX_Mode(txMode: Mode): void {" line248="        // FF 00 03 42 01 45; 4FSK mode" line249="        // FF 00 03 42 10 54; 8FSK mode" line250="        // Query FF 00 02 42 43" line251="        if (txMode === Mode.FSK4) {   // 4FSK" line252="            const response6 = Send_ZETag_command([0xff, 0x00, 0x03, 0x42, 0x01, 0x45])" line253="        } else {                    // 8FSK" line254="            const response62 = Send_ZETag_command([0xff, 0x00, 0x03, 0x42, 0x10, 0x54])" line255="        }" line256="    }" line257="" line258="    // --- UI 用の enum（ドロップダウン生成） ---" line259="    export enum ChSpace {" line260="        //% block=&quot;100&quot;" line261="        KHz100 = 100," line262="        //% block=&quot;200&quot;" line263="        KHz200 = 200" line264="    }" line265="    export enum ChNum {" line266="        //% block=&quot;1&quot;" line267="        _1 = 1," line268="        //% block=&quot;2&quot;" line269="        _2 = 2," line270="        //% block=&quot;3&quot;" line271="        _3 = 3," line272="        //% block=&quot;4&quot;" line273="        _4 = 4," line274="        //% block=&quot;5&quot;" line275="        _5 = 5," line276="        //% block=&quot;6&quot;" line277="        _6 = 6," line278="    }" line279="    export enum TxPower {" line280="        //% block=&quot;2&quot;" line281="        dBm2 = 2," line282="        //% block=&quot;4&quot;" line283="        dBm4 = 4," line284="        //% block=&quot;6&quot;" line285="        dBm6 = 6," line286="        //% block=&quot;8&quot;" line287="        dBm8 = 8," line288="        //% block=&quot;10&quot;" line289="        dBm10 = 10," line290="    }" line291="    export enum Mode {" line292="        //% block=&quot;4FSK&quot;" line293="        FSK4 = 0," line294="        //% block=&quot;8FSK&quot;" line295="        FSK8 = 1" line296="    }" line297="" line298="    export enum OP_Mode {" line299="        //% block=&quot;Normal&quot;" line300="        Normal = 0," line301="        //% block=&quot;Test&quot;" line302="        Test = 1" line303="    }" line304="" line305="    // --- 5項目をまとめた設定ブロック（完成版） ---" line306="    /**" line307="     * ZETag の無線設定（周波数・帯域幅・チャンネル数・出力・送信モード）をまとめて適用" line308="     */" line309="    //% blockId=zetag_setting" line310="    //% block=&quot;ZETag Setting|Frequency(Hz) %frequency|Band width(kHz) %chSpace|Number of Channel(ch) %chNum|Tx Power(dB) %txPower|Mode %mode&quot;" line311="    //% group=&quot;ZETag Setting&quot; weight=95 blockGap=8" line312="    //% frequency.min=470000000 frequency.max=928000000 frequency.defl=922080000" line313="    //% chSpace.defl=ChSpace.KHz200" line314="    //% chNum.defl=ChNum._2" line315="    //% txPower.defl=TxPower.dBm8" line316="    //% mode.defl=Mode.FSK4" line317="    export function applySetting(" line318="        frequency: number," line319="        chSpace: ChSpace," line320="        chNum: ChNum," line321="        txPower: TxPower," line322="        mode: Mode" line323="    ): void {" line324="        // 0) 変調方式の設定" line325="        Set_TX_Mode(mode)" line326="" line327="        // 1) 帯域幅の設定 いずれの設定でも100KHzにする" line328="        Set_channel_spacing(ChSpace.KHz100)" line329="" line330="        // 2) Tx 出力の設定" line331="        Set_TX_Power(txPower)" line332="" line333="        // 3) 周波数＋チャンネルの設定（Band width に応じて chStep を自動決定）" line334="        const chStep = (chSpace === ChSpace.KHz200) ? 2 : 1" line335="        Set_Frequency(frequency, chNum, chStep)" line336="    }" line337="}" numlines="338"></mutation></block></statement></block></xml>